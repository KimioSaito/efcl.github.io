{"version":3,"sources":["../../src/task/textlint-core-task.js"],"names":[],"mappings":"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","file":"textlint-core-task.js","sourcesContent":["// LICENSE : MIT\n\"use strict\";\nconst EventEmitter = require(\"events\");\nconst TraverseController = require(\"txt-ast-traverse\").Controller;\nconst PromiseEventEmitter = require(\"carrack\");\nimport RuleError from \"../core/rule-error\";\nimport SourceLocation from \"../core/source-location\";\nconst traverseController = new TraverseController();\nconst debug = require(\"debug\")(\"textlint:core-task\");\n// Promised EventEmitter\nclass RuleTypeEmitter extends PromiseEventEmitter {\n    constructor() {\n        super();\n        this.setMaxListeners(0);\n    }\n}\nexport default class TextLintCoreTask extends EventEmitter {\n    static get events() {\n        return {\n            // receive start event\n            start: \"start\",\n            // receive message from each rules\n            message: \"message\",\n            // receive complete event\n            complete: \"complete\",\n            // receive error event\n            error: \"error\"\n        };\n    }\n\n    constructor({config, ruleCreatorSet, sourceCode}) {\n        super();\n        this.config = config;\n        this.ruleCreatorSet = ruleCreatorSet;\n        this.sourceCode = sourceCode;\n        this.ruleTypeEmitter = new RuleTypeEmitter();\n    }\n\n    createReporter(sourceCode) {\n        const sourceLocation = new SourceLocation(sourceCode);\n\n        /**\n         * @typedef {Object} ReportMessage\n         * @property {string} ruleId\n         * @property {TxtNode} node\n         * @property {number} severity\n         * @property {RuleError} ruleError error is a RuleError instance or any data\n         */\n        /**\n         * push new RuleError to results\n         * @param {ReportMessage} reportedMessage\n         */\n        const reportFunction = (reportedMessage) => {\n            const {ruleId, severity, ruleError} = reportedMessage;\n            debug(\"%s pushReport %s\", ruleId, ruleError);\n            const {line, column, fix} = sourceLocation.adjust(reportedMessage);\n            // add TextLintMessage\n            const message = {\n                ruleId: ruleId,\n                message: ruleError.message,\n                // See https://github.com/textlint/textlint/blob/master/typing/textlint.d.ts\n                line: line,        // start with 1(1-based line number)\n                column: column + 1,// start with 1(1-based column number)\n                severity: severity // it's for compatible ESLint formatter\n            };\n            if (fix) {\n                message.fix = fix;\n            }\n            if (!(ruleError instanceof RuleError)) {\n                // `error` is a any data.\n                const data = ruleError;\n                message.data = data;\n            }\n            this.emit(TextLintCoreTask.events.message, message);\n        };\n        return reportFunction;\n    }\n\n    /**\n     * start process and emitting events.\n     * You can listen message by `task.on(\"message\", message => {})`\n     */\n    start() {\n        const promiseQueue = [];\n        const listenerCount = (typeof this.ruleTypeEmitter.listenerCount !== \"undefined\")\n            ? this.ruleTypeEmitter.listenerCount.bind(this.ruleTypeEmitter) // Node 4.x >=\n            : EventEmitter.listenerCount.bind(EventEmitter, this.ruleTypeEmitter);// Node 0.12\n\n        this.emit(TextLintCoreTask.events.start);\n\n        const ruleTypeEmitter = this.ruleTypeEmitter;\n        traverseController.traverse(this.sourceCode.ast, {\n            enter(node, parent) {\n                const type = node.type;\n                Object.defineProperty(node, \"parent\", {value: parent});\n                if (listenerCount(type) > 0) {\n                    const promise = ruleTypeEmitter.emit(type, node);\n                    promiseQueue.push(promise);\n                }\n            },\n            leave(node) {\n                const type = `${node.type}:exit`;\n                if (listenerCount(type) > 0) {\n                    const promise = ruleTypeEmitter.emit(type, node);\n                    promiseQueue.push(promise);\n                }\n            }\n        });\n        Promise.all(promiseQueue).then(() => {\n            this.emit(TextLintCoreTask.events.complete);\n        }).catch(error => {\n            this.emit(TextLintCoreTask.events.error, error);\n        });\n    }\n}\n"]}