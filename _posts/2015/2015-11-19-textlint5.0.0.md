---
title: ""
author: azu
layout: post
date : 2015-11-19T10:09
category: JavaScript
tags:
    - 

---

[textlint](https://github.com/textlint/textlint "textlint") 5.0.0をリリースしました。

- [Release 5.0.0: Async support · textlint/textlint](https://github.com/textlint/textlint/releases/tag/5.0.0 "Release 5.0.0: Async support · textlint/textlint")

## 変更点

### Breaking Change

大きな変更点として全てのLint APIが非同期処理となりました。
そのため、以下のメソッドはそれぞれPromiseを返すようになっています。

textlintツール利用者には影響なくて、textlintをモジュールとして使ってる人のみに影響します。

- `TextLintCore#LintFile`
- `TextLintCore#LintText`
- `TextLintEngine#executeOnFiles`
- `TextLintEngine#executeOnText`
- `cli#execute`

```js
var textlint = new TextLintCore();
textlint.lintMarkdown("text").then(result => {
      // 
});
```

## 新しい機能

- [ ] Plugin Processor
- [textlint/textlint-plugin-html](https://github.com/textlint/textlint-plugin-html "textlint/textlint-plugin-html")

について

- ルール内で非同期処理ができるようになりました
- [Rule: async support · Issue #74 · textlint/textlint](https://github.com/textlint/textlint/issues/74 "Rule: async support · Issue #74 · textlint/textlint")

今まではルール内は同期的な処理しか書けませんでしたが、
5.0.0からはpromiseオブジェクトを返すとそのpromiseが解決できるまで結果を待つようになっています。

以下のように非同期処理をルール中に書くことができます。
(同期処理は今までで何も変わらない)

```js
export default function (context) {
    return {
        [Syntax.Str](node){
            // textlint wait for resolved the promise.
            return new Promise((resolve, reject) => {
                // async task
            });
        }
    }
}
```

### 非同期の使い道

ほぼ同じ機構を持つESLintが非同期対応してないことからも分かりますが、普通のLintではあまり非同期APIは必要ないと思います。

textlintはESLintと違って自然言語を扱うことが多いので、自然言語についてはJavaScript以外のプログラミング言語のほうがライブラリが充実していたりすることが多いです。

そのため、textlintからREST APIを通信してLintをしたりできるようにするために入れた変更です。

<blockquote class="twitter-tweet" lang="en"><p lang="ja" dir="ltr">textlintのruleでYahooの校正API叩くのって悪手かなー。個人で使う分には問題無さそうだけども。</p>&mdash; もろみざとけいた (@kta_moromii) <a href="https://twitter.com/kta_moromii/status/661575606216232960">November 3, 2015</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

また、[kuromoji.js](https://github.com/takuyaa/kuromoji.js "kuromoji.js")のように初期ロードが非同期なものも簡単に対応できるようにするためでもあります。

実際に非同期処理を使ったルールとして[azu/textlint-rule-no-doubled-joshi](https://github.com/azu/textlint-rule-no-doubled-joshi "azu/textlint-rule-no-doubled-joshi")があります。

[textlint-rule-no-doubled-joshi](https://github.com/azu/textlint-rule-no-doubled-joshi "azu/textlint-rule-no-doubled-joshi")は1センテンス中に同じ助詞が連続して使われていないかをチェックするルールです。

> 材料不足で代替素材で製品を作った

を例にすると"で"という助詞が連続しているのは変なのを検出できます。

RedPenの_DoubledJoshi_と大体同じですが、デフォルトでは"の"や"を"例外的に処理してたり緩く設定してあります。`strict:true`としてあげるともう少し厳しく判定するようになっています。

- [RedPen v1.4 のリリース | Advanced Technology Lab](http://atl.recruit-tech.co.jp/blog/3694/ "RedPen v1.4 のリリース | Advanced Technology Lab")

実際に使ってみると結構おかしな部分が引っかかるので、リファクタリングしていくと1センテンスが短くなる効果がありました。

- [textlint: 二重助詞の利用をチェックするルールを追加 by azu · Pull Request #89 · azu/JavaScript-Plugin-Architecture](https://github.com/azu/JavaScript-Plugin-Architecture/pull/89 "textlint: 二重助詞の利用をチェックするルールを追加 by azu · Pull Request #89 · azu/JavaScript-Plugin-Architecture")

1センテンスを短く分解する手法については以下のスライドが参考になります。

- [作文入門](http://www.slideshare.net/takahi-i/ss-13429892 "作文入門")

このルールは[sentence-splitter](https://github.com/azu/sentence-splitter "azu/sentence-splitter")を使ってパラグラフをセンテンスに分解し、[kuromoji.js](https://github.com/takuyaa/kuromoji.js "kuromoji.js")を使ってセンテンスを形態素解析して品詞をチェックすることでチェックしています。

kuromoji.jsを直接使うと同時に辞書を読み込もうとして読み込みが終わらない問題を作りやすいので、[azu/kuromojin](https://github.com/azu/kuromojin "azu/kuromojin")というkuromoji.jsのPromiseラッパを作って使っています。

同時に初期化(辞書を読み込み)しても大丈夫なようにロックと、一度読み込んだら次からキャッシュを使うようにするシンプルなラッパーです。

ルール間で初期化コストを共有できるので、[azu/kuromojin](https://github.com/azu/kuromojin "azu/kuromojin")経由で使っておくと楽なのかもしれません(もっといい方法がありそうならIssueとか立てて下さい)

-----

## その他

Atomプラグインである[linter-textlint](https://github.com/1000ch/linter-textlint "linter-textlint")もtextlint 5.0.0に対応しています。

Atomで書きながらチェック出来るのでかなり便利です。

![textlint-linter](https://monosnap.com/file/L6zYnuUAI7F2v1eShhiUeLxJ3m3KRq.png)

Windowsでの導入方法の例
(特にOS依存はないので、どの環境も普通にnpm installしてプロジェクトを開けば使えます)

- [KenshoFujisaki/TextlintAtom](https://github.com/KenshoFujisaki/TextlintAtom "KenshoFujisaki/TextlintAtom")

gulpから使う場合は[gulp-textlint](https://github.com/textlint/gulp-textlint "gulp-textlint")などもあるので、こちらの方を利用するといい気がします。

### [textstat](https://github.com/azu/textstat "textstat")

[textstat](https://github.com/azu/textstat "textstat")というtextlintの上で動くテキスト統計処理ツールも公開しています。
(Wordの文字数カウントとかそういう感じのものです)

基本的にルールの書き方や設定ファイルの書き方も同じですが、こちらはデフォルトで幾つかルールを持っています。
(言語が関係ないファイルサイズや行数などの統計ルール)

日本語向けのルールを思いつきで書いてる[textstat-plugin-ja](https://github.com/azu/textstat-plugin-ja "textstat-plugin-ja")というプラグインも公開しているので、以下のような手順で使うとサクッとファイルのテキスト統計情報が出せます。

```sh
$ npm install textstat-plugin-ja textstat -g
$ textstat --plugin ja ja/ESLint/README.md
┌──────────────────────┬─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│ filePath             │ ja/ESLint/README.md                                                                                                 │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ fileSize             │ 14.22 kB                                                                                                            │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ number of characters │ 8593                                                                                                                │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ number of Lines      │ 310                                                                                                                 │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ number of Images     │ 0                                                                                                                   │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ number of Links      │ 22                                                                                                                  │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ number of List Items │ 25                                                                                                                  │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ number of Paragraphs │ 80                                                                                                                  │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ number of sentences  │ 169                                                                                                                 │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ share of code        │ 30%                                                                                                                 │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 文字種               │                                                                                                                     │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ ひらがな             │ 39%                                                                                                                 │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ カタカナ             │ 12%                                                                                                                 │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 漢字                 │ 13%                                                                                                                 │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ アルファベット       │ 26%                                                                                                                 │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 日本文の読みやすさ   │ 62                                                                                                                  │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                      │ 読みやすさの偏差値(平均50、標準偏差10、高いほど読みやすい)                                                          │
├──────────────────────┼─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│ 名詞 Top 10          │ ルール: 43, ESLint: 29, よう: 18, AST: 16, コード: 16, JavaScript: 15, オブジェクト: 11, ため: 10, こと: 10, js: 10 │
└──────────────────────┴─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

[textstat](https://github.com/azu/textstat "textstat")も[ルールはJavaScript](https://github.com/azu/textstat#create-rule)で簡単に書けるので、気になった部分を数値として出してみると面白いかもしれません。

## 今後

形態素解析を使ったルールも書けるようになったので、初期にやりたかった事は大体できた気がします。

ルールもある程度増えてきたので、逆にどうやって使い始めればいいかみたいなドキュメントが不足してるのでその辺を追加する予定です。
(日本語向けのルールばかりなので、普通に日本語向けの初期設定を作る感じになりそうな気はします)

- [Collection of textlint rule · textlint/textlint Wiki](https://github.com/textlint/textlint/wiki/Collection-of-textlint-rule "Collection of textlint rule · textlint/textlint Wiki")

